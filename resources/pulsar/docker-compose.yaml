version: '3.8'
services:
  pulsar:
    image: apachepulsar/pulsar:4.0.6
    container_name: pulsar-standalone
    ports:
      - "6650:6650"
      - "8080:8080"
    environment:
      - PULSAR_STANDALONE_USE_ZOOKEEPER=1
    volumes:
      - pulsardata:/pulsar/data
      - pulsarconf:/pulsar/conf
    command: bin/pulsar standalone
    healthcheck:
      test: ["CMD", "bin/pulsar-admin", "brokers", "healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  pulsar-init:
    image: apachepulsar/pulsar:4.0.6
    depends_on:
      pulsar:
        condition: service_healthy
    environment:
      - TENANT=${TENANT:-t2050305588}
    command: >
      bash -c '
        set +e
        echo "Waiting for Pulsar to be ready..." &&
        sleep 10 &&
        
        echo "Creating tenant $TENANT..." &&
        bin/pulsar-admin --admin-url http://pulsar:8080 tenants create $TENANT --admin-roles admin --allowed-clusters standalone
        if [ $? -eq 0 ]; then
          echo "Tenant $TENANT created successfully"
        else
          echo "Tenant $TENANT already exists or creation failed, continuing..."
        fi
        
        echo "Creating namespace $TENANT/mqtt..." &&
        bin/pulsar-admin --admin-url http://pulsar:8080 namespaces create $TENANT/mqtt
        if [ $? -eq 0 ]; then
          echo "Namespace $TENANT/mqtt created successfully"
        else
          echo "Namespace $TENANT/mqtt already exists or creation failed, continuing..."
        fi
        
        echo "Setup completed successfully!"
        exit 0
      '

volumes:
  pulsardata:
  pulsarconf: