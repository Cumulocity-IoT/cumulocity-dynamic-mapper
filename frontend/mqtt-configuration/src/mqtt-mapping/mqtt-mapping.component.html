<c8y-title translate>MQTT</c8y-title>

<c8y-action-bar-item [placement]="'right'">
  <button class="btn btn-link" title="{{ 'Add mapping' | translate }}" (click)="addMapping()">
    <i c8yIcon="plus-circle"></i>
    {{ 'Add mapping' | translate }}
  </button>

  <button class="btn btn-link" title="{{ 'Save changes' | translate }}" (click)="onSaveButtonClicked()">
    <i c8yIcon="save"></i>
    {{ 'Save changes' | translate }}
  </button>
</c8y-action-bar-item>
<div class="card w-75">
  <div class="col-xs-12 col-sm-10 col-md-8 col-lg-12 bg-white">
    <div class="card-header separator j-c-between">
      <p class="card-title" translate>Mapping</p>
    </div>
    <div class="card-block">
      <c8y-data-grid [title]="'Mapping List' | translate" [columns]="columns" [rows]="mqttMappings"
        [pagination]="pagination" [actionControls]="actionControls" [displayOptions]="displayOptions">
      </c8y-data-grid>
    </div>
    <div class="card-block">
      <div class="card-header separator j-c-between" style=" margin-bottom: 30px;">
        <h4 style="font-weight:300 !important;" translate>Edit Mapping</h4>
      </div>
      <div [formGroup]="mappingForm" class="form-horizontal">
        <!--         <div class="form-group">
          <label for="id" class="col-sm-2" translate>Id</label>
          <div class="col-sm-4">
            <input formControlName="id" type="text" class="form-control" #idRef required readonly />
          </div>
        </div> -->
        <div class="row">
          <div class ="col-lg-5">
            <div class="form-group">
              <label for="topic" class="" translate>Topic</label>
              <div class="">
                <input formControlName="topic" type="text" class="form-control" placeholder="e.g. /device/110" #idRef
                  required />
              </div>
            </div>
            <div class="form-group">
              <label for="targetAPI" class="" translate>Target API</label>
              <div class="">
                <select class="form-control" formControlName="targetAPI" #targetAPIRef>
                  <option *ngFor="let api of APIs" [ngValue]="api">
                    {{ api }}
                  </option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label for="qos" class="" translate>QOS</label>
              <div class="">
                <select class="form-control" formControlName="qos" #qosRef>
                  <option *ngFor="let q of QOSs" [ngValue]="q.value">
                    {{ q.name }}
                  </option>
                </select>
              </div>
            </div>
          </div>
          <div class="col-lg-1">
          </div>
          <div class="col-lg-5">
            <div class="form-group">
              <label for="active" class="" translate>Mapping Active</label>
              <div class="">
                <input formControlName="active" type="checkbox" class="form-control" #activeRef />
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-lg-5" style="height:200px">
            <label for="jsonPathResult" class="" translate>Template message - source</label>
            <ngx-monaco-editor formControlName="source" [options]="editorOptionsJson" [(ngModel)]="mappingForm.source">
            </ngx-monaco-editor>
          </div>
          <div class="col-lg-1"></div>
          <div class="col-lg-5" style="height:200px">
            <label for="jsonPathResult" class="" translate>Cumulocity message - target</label>
            <ngx-monaco-editor formControlName="target" [options]="editorOptionsJson" [(ngModel)]="mappingForm.target"
              (change)="trackVariables()">
            </ngx-monaco-editor>
          </div>
        </div>
      </div>
    </div>

    <div class="card-block">
      <div class="card-header separator j-c-between" style=" margin-bottom: 30px;">
        <h4 style="font-weight:300 !important;" translate>Explore source payload</h4>
      </div>
      <div [formGroup]="jsonPathForm" class="form-horizontal">
        <div class="row">
          <div class="col-lg-5">
            <div class="form-group">
              <label for="path" class="" translate>Json path</label>
              <div class="">
                <input formControlName="path" type="text" class="form-control" (change)="onJsonPathChanged()"
                  placeholder="e.g. $.device" #pathRef/>
              </div>
            </div>
            <div class="form-group">
              <div class="" style="height:200px">
                <ngx-monaco-editor id="jsonPathResult" formControlName="result" [options]="editorOptionsResult"
                  [(ngModel)]="jsonPathForm.result">
                </ngx-monaco-editor>
              </div>
            </div>
          </div>
          <div class="col-lg-1"></div>
          <div class="col-lg-5">
              <div class="form-group">
                <label for="variableNames" class="" translate>Names of substitution variables</label>
                <input formControlName="variableNames" type="text" class="form-control"
                #variableNamesRef readonly />
              </div>
              <div class="form-group">
                <label for="variableJsonPathes" class="" translate>Json path for every variable</label>
                <input formControlName="variableJsonPathes" type="text" class="form-control"
                  (change)="onMappingJsonPathChanged()"
                  placeholder="JsonPath for ervery variable, separested by comms (,) e.g. $.device,$.value, $.timestamp"
                  #variableJsonPathesRef required />
              </div>
              <div style="height:100px" class="form-group">
                <label for="testResult" class="" translate>Cumulocity message - test</label>
                 <ngx-monaco-editor [options]="editorOptionsResult" formControlName="testResult" [(ngModel)]="testResult">
                </ngx-monaco-editor>
              </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="form-group">
    <button type="button" name="commit" class="btn btn-primary" (click)="onCommitButtonClicked()"
      [disabled]="false" translate>
      Commit changes
    </button>
    <button type="button" name="format" class="btn btn-default" (click)="onFormatButtonClicked()" translate>
      Format templates
    </button>
    <button type="button" name="sample" class="btn btn-default" (click)="onSampleButtonClicked()" translate>
      Sample target template
    </button>
    <button type="button" name="test" class="btn btn-default" (click)="onTestClicked()" [disabled]="!isSubstitutionValid" translate>
      Send test message
    </button>
  </div>
</div>